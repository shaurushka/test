version: '1'
hooks:
- type: log_node_output
  params: 
    df_log_method: tail
    nodes:
      - dropna
      - dropna_1
      - dropna_2
      - drop_false
      - drop_false_1
      - drop_false_2
      
relations:
  platform_raw_subscription:
    outputs: out_0
  rename_input: 
    inputs: out_0
    outputs: out_1
  evals:
    inputs: out_1
    outputs: out_2
  split_df:
    inputs: out_2
    outputs:
    - out_2_1
    - out_2_2
    - out_2_4
    - out_3_4
    - out_4_4

  new_data_flag_computation:
    inputs: out_2_2
    outputs: out_2_3
  platform_write:
    inputs: out_2_1
  write_last:
    inputs: out_2_3
  dropna:
    inputs: out_2_4
    outputs: out_2_5
  dropna_1:
    inputs: out_4_4
    outputs: out_4_5
  dropna_2:
    inputs: out_3_4
    outputs: out_3_5
  split_df_2:
    inputs: out_2_3
    outputs: 
    - out_2_6  
    - out_2_7
    - out_2_8
  drop_false: 
    inputs: out_2_6
    outputs: out_2_6_1
  drop_false_1: 
    inputs: out_2_7
    outputs: out_2_7_1
  drop_false_2: 
    inputs: out_2_8
    outputs: out_2_8_1

nodes:
  platform_raw_subscription:
    type: platform_raw_subscription
    params:
      history_size: 240min
      listen_signals:
        - LIMS_41-1.1a_Двачаса_Ni
        - LIMS_41-1.1a_Двачаса_Cu
        - LIMS_41-1.1a_Двачаса_Co
        - LIMS_41-1.24d_Выборка_SiO2
        - LIMS_41-1.24d_Выборка_S
        - LIMS_41-1.24d_Выборка_Fe
        - LIMS_41-1.24d_Выборка_Fe3O4
        - LIMS_41-1.24d_Выборка_Co
        - LIMS_41-1.24d_Выборка_Cu
        - LIMS_41-1.24d_Выборка_Ni
        - LIMS_41-1.24e_Выборка_SiO2
        - LIMS_41-1.24e_Выборка_S
        - LIMS_41-1.24e_Выборка_Fe
        - LIMS_41-1.24e_Выборка_Fe3O4
        - LIMS_41-1.24e_Выборка_Co
        - LIMS_41-1.24e_Выборка_Cu
        - LIMS_41-1.24e_Выборка_Ni
        - LIMS_41-1.24f_Выборка_SiO2
        - LIMS_41-1.24f_Выборка_S
        - LIMS_41-1.24f_Выборка_Fe
        - LIMS_41-1.24f_Выборка_Fe3O4
        - LIMS_41-1.24f_Выборка_Co
        - LIMS_41-1.24f_Выборка_Cu
        - LIMS_41-1.24f_Выборка_Ni
        - LIMS_41-1.24g_Выборка_SiO2
        - LIMS_41-1.24g_Выборка_S
        - LIMS_41-1.24g_Выборка_Fe
        - LIMS_41-1.24g_Выборка_Fe3O4
        - LIMS_41-1.24g_Выборка_Co
        - LIMS_41-1.24g_Выборка_Cu
        - LIMS_41-1.24g_Выборка_Ni
        - LIMS_41-1.25f_Выборка_SiO2
        - LIMS_41-1.25f_Выборка_S
        - LIMS_41-1.25f_Выборка_Fe
        - LIMS_41-1.25f_Выборка_Fe3O4
        - LIMS_41-1.25f_Выборка_Co
        - LIMS_41-1.25f_Выборка_Cu
        - LIMS_41-1.25f_Выборка_Ni
        - LIMS_41-1.25f_Выборка_Al2O3
        - LIMS_41-1.25f_Выборка_MgO
        - LIMS_41-1.25f_Выборка_CaO
        - LIMS_41-1.25g_Выборка_SiO2
        - LIMS_41-1.25g_Выборка_S
        - LIMS_41-1.25g_Выборка_Fe
        - LIMS_41-1.25g_Выборка_Fe3O4
        - LIMS_41-1.25g_Выборка_Co
        - LIMS_41-1.25g_Выборка_Cu
        - LIMS_41-1.25g_Выборка_Ni
        - LIMS_41-1.25g_Выборка_Al2O3
        - LIMS_41-1.25g_Выборка_MgO
        - LIMS_41-1.25g_Выборка_CaO
        - nmz_fsf2_metal_sum_conc
        - nmz_fsf2_metal_sum_matte_raw
        - nmz_fsf2_metal_sum_slag_raw

  rename_input:
    type: df_rename
    params:
      rename_dict:
        nmz_fsf2_metal_sum_conc: last_lims_conc_prev
        nmz_fsf2_metal_sum_matte_raw: last_lims_matte_prev
        nmz_fsf2_metal_sum_slag_raw: last_lims_slag_prev

  evals:
    type: mdk_sequential_pipeline
    params:
      pipeline:
        __instance__: SequentialPipeline
        params:
          steps:
          - __instance__: PandasEval
            params:
              expressions:
              # calculate last slag analyzes to one common signal  
              - - nmz_fsf2_metal_sum_conc
                - "(`LIMS_41-1.1a_Двачаса_Ni` + `LIMS_41-1.1a_Двачаса_Cu` + `LIMS_41-1.1a_Двачаса_Co`)"
              - - nmz_fsf2_metal_sum_conc
                - "`nmz_fsf2_metal_sum_conc`.round(2)"
              - - last_lims_matte_fsf_2_Выборка_SiO2
                - "`LIMS_41-1.24d_Выборка_SiO2`.combine_first(`LIMS_41-1.24e_Выборка_SiO2`).combine_first(`LIMS_41-1.24f_Выборка_SiO2`).combine_first(`LIMS_41-1.24g_Выборка_SiO2`).round(2)"
              - - last_lims_matte_fsf_2_Выборка_S
                - "`LIMS_41-1.24d_Выборка_S`.combine_first(`LIMS_41-1.24e_Выборка_S`).combine_first(`LIMS_41-1.24f_Выборка_S`).combine_first(`LIMS_41-1.24g_Выборка_S`).round(2)"
              - - last_lims_matte_fsf_2_Выборка_Fe
                - "`LIMS_41-1.24d_Выборка_Fe`.combine_first(`LIMS_41-1.24e_Выборка_Fe`).combine_first(`LIMS_41-1.24f_Выборка_Fe`).combine_first(`LIMS_41-1.24g_Выборка_Fe`).round(2)"
              - - last_lims_matte_fsf_2_Выборка_Fe3O4
                - "`LIMS_41-1.24d_Выборка_Fe3O4`.combine_first(`LIMS_41-1.24e_Выборка_Fe3O4`).combine_first(`LIMS_41-1.24f_Выборка_Fe3O4`).combine_first(`LIMS_41-1.24g_Выборка_Fe3O4`).round(2)"
              - - last_lims_matte_fsf_2_Выборка_Co
                - "`LIMS_41-1.24d_Выборка_Co`.combine_first(`LIMS_41-1.24e_Выборка_Co`).combine_first(`LIMS_41-1.24f_Выборка_Co`).combine_first(`LIMS_41-1.24g_Выборка_Co`).round(2)"
              - - last_lims_matte_fsf_2_Выборка_Cu
                - "`LIMS_41-1.24d_Выборка_Cu`.combine_first(`LIMS_41-1.24e_Выборка_Cu`).combine_first(`LIMS_41-1.24f_Выборка_Cu`).combine_first(`LIMS_41-1.24g_Выборка_Cu`).round(2)"
              - - last_lims_matte_fsf_2_Выборка_Ni
                - "`LIMS_41-1.24d_Выборка_Ni`.combine_first(`LIMS_41-1.24e_Выборка_Ni`).combine_first(`LIMS_41-1.24f_Выборка_Ni`).combine_first(`LIMS_41-1.24g_Выборка_Ni`).round(2)"
              - - nmz_fsf2_metal_sum_matte_raw
                - "(`last_lims_matte_fsf_2_Выборка_Ni` + `last_lims_matte_fsf_2_Выборка_Cu`+ `last_lims_matte_fsf_2_Выборка_Co`)"
              - - last_lims_slag_fsf_2_Выборка_SiO2
                - "`LIMS_41-1.25f_Выборка_SiO2`.combine_first(`LIMS_41-1.25g_Выборка_SiO2`).round(2)"
              - - last_lims_slag_fsf_2_Выборка_S
                - "`LIMS_41-1.25f_Выборка_S`.combine_first(`LIMS_41-1.25g_Выборка_S`).round(2)"
              - - last_lims_slag_fsf_2_Выборка_Fe
                - "`LIMS_41-1.25f_Выборка_Fe`.combine_first(`LIMS_41-1.25g_Выборка_Fe`).round(2)"
              - - last_lims_slag_fsf_2_Выборка_Fe3O4
                - "`LIMS_41-1.25f_Выборка_Fe3O4`.combine_first(`LIMS_41-1.25g_Выборка_Fe3O4`).round(2)"
              - - last_lims_slag_fsf_2_Выборка_Co
                - "`LIMS_41-1.25f_Выборка_Co`.combine_first(`LIMS_41-1.25g_Выборка_Co`).round(3)"
              - - last_lims_slag_fsf_2_Выборка_Cu
                - "`LIMS_41-1.25f_Выборка_Cu`.combine_first(`LIMS_41-1.25g_Выборка_Cu`).round(2)"
              - - last_lims_slag_fsf_2_Выборка_Ni
                - "`LIMS_41-1.25f_Выборка_Ni`.combine_first(`LIMS_41-1.25g_Выборка_Ni`).round(2)"
              - - last_lims_slag_fsf_2_Выборка_Al2O3
                - "`LIMS_41-1.25f_Выборка_Al2O3`.combine_first(`LIMS_41-1.25g_Выборка_Al2O3`).round(2)"
              - - last_lims_slag_fsf_2_Выборка_MgO
                - "`LIMS_41-1.25f_Выборка_MgO`.combine_first(`LIMS_41-1.25g_Выборка_MgO`).round(2)"
              - - last_lims_slag_fsf_2_Выборка_CaO
                - "`LIMS_41-1.25f_Выборка_CaO`.combine_first(`LIMS_41-1.25g_Выборка_CaO`).round(2)"
              - - nmz_fsf2_metal_sum_slag_raw
                - "(`last_lims_slag_fsf_2_Выборка_Ni` + `last_lims_slag_fsf_2_Выборка_Cu`+ `last_lims_slag_fsf_2_Выборка_Co`)"            
              - - last_lims_analysis_fsf_2
                - "nmz_fsf2_metal_sum_slag_raw.fillna(nmz_fsf2_metal_sum_conc).fillna(nmz_fsf2_metal_sum_matte_raw)"

  split_df:
    type: df_split
    params:
      column_groups:
      - - nmz_fsf2_metal_sum_conc
        - last_lims_matte_fsf_2_Выборка_SiO2
        - last_lims_matte_fsf_2_Выборка_S
        - last_lims_matte_fsf_2_Выборка_Fe
        - last_lims_matte_fsf_2_Выборка_Fe3O4
        - last_lims_matte_fsf_2_Выборка_Co
        - last_lims_matte_fsf_2_Выборка_Cu
        - last_lims_matte_fsf_2_Выборка_Ni
        - nmz_fsf2_metal_sum_matte_raw
        - last_lims_slag_fsf_2_Выборка_SiO2
        - last_lims_slag_fsf_2_Выборка_S
        - last_lims_slag_fsf_2_Выборка_Fe
        - last_lims_slag_fsf_2_Выборка_Fe3O4
        - last_lims_slag_fsf_2_Выборка_Co
        - last_lims_slag_fsf_2_Выборка_Cu
        - last_lims_slag_fsf_2_Выборка_Ni
        - last_lims_slag_fsf_2_Выборка_Al2O3
        - last_lims_slag_fsf_2_Выборка_MgO
        - last_lims_slag_fsf_2_Выборка_CaO
        - nmz_fsf2_metal_sum_slag_raw
        - last_lims_analysis_fsf_2
      - - nmz_fsf2_metal_sum_slag_raw
        - last_lims_slag_prev
        - nmz_fsf2_metal_sum_conc
        - last_lims_conc_prev
        - nmz_fsf2_metal_sum_matte_raw
        - last_lims_matte_prev
      - - nmz_fsf2_metal_sum_slag_raw
        - last_lims_slag_prev
      - - nmz_fsf2_metal_sum_matte_raw
        - last_lims_matte_prev
      - - nmz_fsf2_metal_sum_conc
        - last_lims_conc_prev
  
  dropna:
    type: mdk_sequential_pipeline
    params:
      pipeline:
        __instance__: SequentialPipeline
        params:
          steps:
          - __instance__: DropAxisItemByValues
            params:
              axis: 0
              values: 
              - NAN
              how: all
  dropna_1:
    type: mdk_sequential_pipeline
    params:
      pipeline:
        __instance__: SequentialPipeline
        params:
          steps:
          - __instance__: DropAxisItemByValues
            params:
              axis: 0
              values: 
              - NAN
              how: all
  dropna_2:
    type: mdk_sequential_pipeline
    params:
      pipeline:
        __instance__: SequentialPipeline
        params:
          steps:
          - __instance__: DropAxisItemByValues
            params:
              axis: 0
              values: 
              - NAN
              how: all
        
  new_data_flag_computation:
    type: mdk_sequential_pipeline
    params:
      pipeline:
        __instance__: SequentialPipeline
        params:
          steps:
          - __instance__: ColumnsResample
            params:
              interval: 1min
              method: last
          - __instance__: PandasEval
            params:
              expressions:
                # matte  
                - - has_new_data_matte
                  - ~(nmz_fsf2_metal_sum_matte_raw.shift(-1).isna())
                - - no_old_data_matte
                  - last_lims_matte_prev.shift(-1).isna()
                - - new_data_matte
                  - (has_new_data_matte & no_old_data_matte) 
                # slag
                - - has_new_data_slag
                  - ~(nmz_fsf2_metal_sum_slag_raw.shift(-1).isna())
                - - no_old_data_slag
                  - last_lims_slag_prev.shift(-1).isna()
                - - new_data_slag
                  - (has_new_data_slag & no_old_data_slag) 
                # conc
                - - has_new_data_conc
                  - ~(nmz_fsf2_metal_sum_conc.shift(-1).isna())
                - - no_old_data_conc
                  - last_lims_conc_prev.shift(-1).isna()
                - - new_data_conc
                  - (has_new_data_conc & no_old_data_conc) 
                # new data trigger
                - - new_data
                  - (new_data_matte | new_data_slag | new_data_conc) * 1
                - - nmz_fsf2_new_lims_analysis_trigger
                  - new_data.max()
                # new data trigger
                - - new_data_matte
                  - new_data_matte * 1
                - - nmz_fsf2_new_lims_analysis_matte_trigger
                  - new_data_matte.max()
                - - new_data_slag
                  - new_data_slag * 1
                - - nmz_fsf2_new_lims_analysis_slag_trigger
                  - new_data_slag.max()
                - - new_data_conc
                  - new_data_conc * 1
                - - nmz_fsf2_new_lims_analysis_conc_trigger
                  - new_data_conc.max()          
          - __instance__: DropAxisItemByValues
            params:
              axis: 1
              columns:
              - nmz_fsf2_new_lims_analysis_trigger
              - nmz_fsf2_new_lims_analysis_matte_trigger
              - nmz_fsf2_new_lims_analysis_slag_trigger
              - nmz_fsf2_new_lims_analysis_conc_trigger
              values:
              - 0
  split_df_2:
    type: df_split
    params:
      column_groups:
      - - has_new_data_matte
        - no_old_data_matte
      - - has_new_data_slag
        - no_old_data_slag
      - - has_new_data_conc
        - no_old_data_conc
  drop_false:
    type: mdk_sequential_pipeline
    params:
      pipeline:
        __instance__: SequentialPipeline
        params:
          steps:
          - __instance__: DropAxisItemByValues
            params:
              axis: 0
              values:
              - False
              how: any
  drop_false_1:
    type: mdk_sequential_pipeline
    params:
      pipeline:
        __instance__: SequentialPipeline
        params:
          steps:
          - __instance__: DropAxisItemByValues
            params:
              axis: 0
              values:
              - False
              how: any
  drop_false_2:
    type: mdk_sequential_pipeline
    params:
      pipeline:
        __instance__: SequentialPipeline
        params:
          steps:
          - __instance__: DropAxisItemByValues
            params:
              axis: 0
              values:
              - False
              how: any
  platform_write:
    type: platform_write
    params:
      strict: false
      nan_strategy: drop
      signals_ids:
      - nmz_fsf2_metal_sum_conc
      - last_lims_matte_fsf_2_Выборка_SiO2
      - last_lims_matte_fsf_2_Выборка_S
      - last_lims_matte_fsf_2_Выборка_Fe
      - last_lims_matte_fsf_2_Выборка_Fe3O4
      - last_lims_matte_fsf_2_Выборка_Co
      - last_lims_matte_fsf_2_Выборка_Cu
      - last_lims_matte_fsf_2_Выборка_Ni
      - nmz_fsf2_metal_sum_matte_raw
      - last_lims_slag_fsf_2_Выборка_SiO2
      - last_lims_slag_fsf_2_Выборка_S
      - last_lims_slag_fsf_2_Выборка_Fe
      - last_lims_slag_fsf_2_Выборка_Fe3O4
      - last_lims_slag_fsf_2_Выборка_Co
      - last_lims_slag_fsf_2_Выборка_Cu
      - last_lims_slag_fsf_2_Выборка_Ni
      - last_lims_slag_fsf_2_Выборка_Al2O3
      - last_lims_slag_fsf_2_Выборка_MgO
      - last_lims_slag_fsf_2_Выборка_CaO
      - nmz_fsf2_metal_sum_slag_raw
      - last_lims_analysis_fsf_2
      
  write_last:
    type: platform_write_last
    params:
      strict: false
      use_current_timestamp: true
      signals_ids:
      - nmz_fsf2_new_lims_analysis_trigger
      - nmz_fsf2_new_lims_analysis_matte_trigger
      - nmz_fsf2_new_lims_analysis_slag_trigger
      - nmz_fsf2_new_lims_analysis_conc_trigger

runner:
  type: scheduled
  params:
    n_retries: 1
    heartbeat_signal: nmz_fsf2_lims_evals_heartbeat
    fail_allowed: false
    triggers:
      - type: interval_trigger
        params:
          interval: 5s
